(function(){function s(l,e,n){function t(_,r){if(!e[_]){if(!l[_]){var i="function"==typeof require&&require;if(!r&&i)return i(_,!0);if(o)return o(_,!0);var d=new Error("Cannot find module '"+_+"'");throw d.code="MODULE_NOT_FOUND",d}var a=e[_]={exports:{}};l[_][0].call(a.exports,function(e){var o=l[_][1][e];return t(o||e)},a,a.exports,s,l,e,n)}return e[_].exports}for(var o="function"==typeof require&&require,r=0;r<n.length;r++)t(n[r]);return t}return s})()({1:[function(e,t){'use strict';function o(e){console&&console.warn&&console.warn(e)}function n(){n.init.call(this)}function r(e){if("function"!=typeof e)throw new TypeError("The \"listener\" argument must be of type Function. Received type "+typeof e)}function s(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function i(e,t,n,i){var l,a,_;if(r(n),a=e._events,void 0===a?(a=e._events=Object.create(null),e._eventsCount=0):(void 0!==a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),_=a[t]),void 0===_)_=a[t]=n,++e._eventsCount;else if("function"==typeof _?_=a[t]=i?[n,_]:[_,n]:i?_.unshift(n):_.push(n),l=s(e),0<l&&_.length>l&&!_.warned){_.warned=!0;var p=new Error("Possible EventEmitter memory leak detected. "+_.length+" "+(t+" listeners added. Use emitter.setMaxListeners() to increase limit"));p.name="MaxListenersExceededWarning",p.emitter=e,p.type=t,p.count=_.length,o(p)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function a(e,t,o){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:o},r=l.bind(n);return r.listener=o,n.wrapFn=r,r}function _(e,t,o){var n=e._events;if(n===void 0)return[];var r=n[t];return void 0===r?[]:"function"==typeof r?o?[r.listener||r]:[r]:o?c(r):d(r,r.length)}function p(e){var t=this._events;if(t!==void 0){var o=t[e];if("function"==typeof o)return 1;if(void 0!==o)return o.length}return 0}function d(e,t){for(var o=Array(t),n=0;n<t;++n)o[n]=e[n];return o}function E(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function c(e){for(var t=Array(e.length),o=0;o<t.length;++o)t[o]=e[o].listener||e[o];return t}var L,f="object"==typeof Reflect?Reflect:null,w=f&&"function"==typeof f.apply?f.apply:function(e,t,o){return Function.prototype.apply.call(e,t,o)};L=f&&"function"==typeof f.ownKeys?f.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var m=Number.isNaN||function(e){return e!==e};t.exports=n,t.exports.once=function(e,t){return new Promise(function(o,n){function r(){s!==void 0&&e.removeListener("error",s),o([].slice.call(arguments))}var s;"error"!==t&&(s=function(o){e.removeListener(t,r),n(o)},e.once("error",s)),e.once(t,r)})},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var I=10;Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return I},set:function(e){if("number"!=typeof e||0>e||m(e))throw new RangeError("The value of \"defaultMaxListeners\" is out of range. It must be a non-negative number. Received "+e+".");I=e}}),n.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||0>e||m(e))throw new RangeError("The value of \"n\" is out of range. It must be a non-negative number. Received "+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return s(this)},n.prototype.emit=function(e){for(var t=[],o=1;o<arguments.length;o++)t.push(arguments[o]);var n="error"===e,r=this._events;if(r!==void 0)n=n&&r.error===void 0;else if(!n)return!1;if(n){var s;if(0<t.length&&(s=t[0]),s instanceof Error)throw s;var l=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw l.context=s,l}var a=r[e];if(a===void 0)return!1;if("function"==typeof a)w(a,this,t);else for(var _=a.length,p=d(a,_),o=0;o<_;++o)w(p[o],this,t);return!0},n.prototype.addListener=function(e,t){return i(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return i(this,e,t,!0)},n.prototype.once=function(e,t){return r(t),this.on(e,a(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return r(t),this.prependListener(e,a(this,e,t)),this},n.prototype.removeListener=function(e,t){var o,n,s,l,a;if(r(t),n=this._events,void 0===n)return this;if(o=n[e],void 0===o)return this;if(o===t||o.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,o.listener||t));else if("function"!=typeof o){for(s=-1,l=o.length-1;0<=l;l--)if(o[l]===t||o[l].listener===t){a=o[l].listener,s=l;break}if(0>s)return this;0===s?o.shift():E(o,s),1===o.length&&(n[e]=o[0]),void 0!==n.removeListener&&this.emit("removeListener",e,a||t)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,o,n;if(o=this._events,void 0===o)return this;if(void 0===o.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==o[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete o[e]),this;if(0===arguments.length){var r,s=Object.keys(o);for(n=0;n<s.length;++n)r=s[n],"removeListener"!==r&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=o[e],"function"==typeof t)this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;0<=n;n--)this.removeListener(e,t[n]);return this},n.prototype.listeners=function(e){return _(this,e,!0)},n.prototype.rawListeners=function(e){return _(this,e,!1)},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},n.prototype.listenerCount=p,n.prototype.eventNames=function(){return 0<this._eventsCount?L(this._events):[]}},{}],2:[function(e,t){t.exports=class{constructor(e=0){this.id=e,this.name="",this.skin="",this.spawn=!1,this.alive=!1,this.spectate=null,this.mouseX=0,this.mouseY=0,this.ejectMarco=!1,this.splitAttempts=0,this.ejectAttempts=0,this.lastEjectTick=0,this.lastSpawnTick=0,this.viewportX=0,this.viewportY=0,this.viewportHW=0,this.viewportHH=0,this.maxScore=0,this.score=0,this.handle=null}reset(){this.handle=null,this.alive=!1,this.spectate=null,this.splitAttempts=0,this.ejectAttempts=0,this.lastEjectTick=0,this.lastSpawnTick=0,this.viewportX=0,this.viewportY=0,this.viewportHW=0,this.viewportHH=0,this.score=0}}},{}],3:[function(e,t){t.exports=class{constructor(e){this.game=e,this.controller=null}join(){this.game.addHandler(this)}remove(){this.game.removeHandler(this)}onSpawn(){}onUpdate(){}onError(){}onChat(){}}},{}],4:[function(e,t){const{EventEmitter:o}=e("events"),n=e("./controller"),r=e("../physics/engine"),s=250;t.exports=class extends o{constructor(){super(),this.controls=Array.from({length:s},(e,t)=>new n(t)),this.engine=new r(this),this.handles=0}addHandler(e){if(this.isFull&&e.onError("Server full"),e.controller)return;let t=1;for(;this.controls[t].handle;)t++;this.controls[t].handle=e,e.controller=this.controls[t],this.handles++,this.emit("join",e.controller)}removeHandler(e){if(e.controller){const t=e.controller;this.engine.kill(t.id),t.reset(),e.controller=null,this.handles--,this.emit("leave",t)}}get isFull(){return this.handles==s}}},{"../physics/engine":16,"./controller":2,events:1}],5:[function(e,t){t.exports=class{constructor(e){this.game=e}broadcast(e,t){for(const o of this.game.controls)o.handle&&o.handle.onChat(e,t)}}},{}],6:[function(e,t){t.exports=class{constructor(e){e.ws=this,this.port=e,this.readyState=WebSocket.OPEN,e.onmessage=t=>{const{data:e}=t;"message"===e.event?this.onmessage(new DataView(e.message)):"close"===e.event&&this.onclose({code:e.code,reason:e.message})},e.start(),e.postMessage({event:"open"}),this.subscribe=this.onmessage=this.onclose=()=>{},this.sock=null}send(e){this.port.postMessage({event:"message",message:e},[e])}end(e=1006,t=""){this.port.postMessage({event:"close",code:e,reason:t}),this.port.close(),this.onclose(e,t)}}},{}],7:[function(e,t){t.exports=class{static handshake(){return!1}constructor(e){this.handler=e}onMessage(){}onUpdate(){}onSpawn(){}onChat(){}onDisconnect(){}}},{}],8:[function(e,t){t.exports=[e("./ogarx")]},{"./ogarx":9}],9:[function(e,t){const o=e("../protocol"),n=e("../reader"),r=e("../writer");t.exports=class extends o{static handshake(e){const t=new n(e);return 3==t.length&&69==t.readUInt8()&&420==t.readInt16()}constructor(e){super(e),this.lastVisible=new Set,this.currVisible=new Set,this.handler.join(),this.sendInitPacket()}sendInitPacket(){const e=new r;e.writeUInt8(1),e.writeUInt16(this.handler.controller.id),e.writeUInt16(this.handler.game.engine.options.MAP_HW),e.writeUInt16(this.handler.game.engine.options.MAP_HH),this.handler.ws.send(e.finalize(),!0)}onMessage(e){const t=new n(e),o=t.readUInt8(),r=this.handler.controller;switch(o){case 1:r.name=t.readUTF16String(),r.skin=t.readUTF16String(),r.spawn=!0;break;case 2:if(r.alive)return;case 3:r.mouseX=t.readFloat32(),r.mouseY=t.readFloat32();const e=t.readUInt8(),n=t.readUInt8(),s=t.readUInt8(),i=t.readUInt8();r.splitAttempts+=n,r.ejectAttempts+=s,r.ejectMarco=!!i;break;case 69:const l=new ArrayBuffer(1);new Uint8Array(l)[0]=69,this.handler.ws.send(l,!0);break;default:console.warn(`Unknown OP: ${o}`);}}onUpdate(){const e=this.handler.game.engine,t=e.cells,o=e.query(this.handler.controller).filter(e=>t[e].type!=255||1<t[e].age);this.currVisible=new Set(o);const n=new r;n.writeUInt8(4),n.writeFloat32(this.handler.controller.viewportX),n.writeFloat32(this.handler.controller.viewportY);const s=[],i=[];for(const e of o)this.lastVisible.has(e)?t[e].type!=254&&i.push(e):s.push(e);for(const e of s){const o=t[e];n.writeUInt16(e),n.writeUInt16(o.isDead?251:o.type),n.writeInt16(~~o.x),n.writeInt16(~~o.y),n.writeUInt16(~~o.r)}n.writeUInt16(0);for(const e of i){const o=t[e];n.writeUInt16(e),n.writeInt16(~~o.x),n.writeInt16(~~o.y),n.writeUInt16(~~o.r)}n.writeUInt16(0);const l=[],a=[];for(const e of this.lastVisible){if(this.currVisible.has(e))continue;const o=t[e];o.shouldRemove&&o.eatenBy?l.push(e):a.push(e)}for(const e of l)n.writeUInt16(e),n.writeUInt16(t[e].eatenBy);n.writeUInt16(0);for(const e of a)n.writeInt16(e);n.writeUInt16(0),this.handler.ws.send(n.finalize(),!0),this.lastVisible=this.currVisible}onSpawn(e){if(this.handler.controller==e){const e=new ArrayBuffer(1);new Uint8Array(e)[0]=2,this.handler.ws.send(e,!0),this.lastVisible.clear()}const t=new r;t.writeUInt8(3),t.writeUInt16(e.id),t.writeUTF16String(e.name),t.writeUTF16String(e.skin),this.handler.ws.send(t.finalize(),!0)}onChat(){}onDisconnect(){this.handler.remove()}}},{"../protocol":7,"../reader":11,"../writer":14}],10:[function(e,t){const o=e("../protocol"),n=e("../reader"),r=e("../writer");t.exports=class extends o{static handshake(e){const t=new n(e);return 3==t.length&&420==t.readInt16()&&69==t.readUInt8()}constructor(e){super(e),this.onTick=this.onTick.bind(this),this.onJoin=this.onJoin.bind(this),this.onLeave=this.onLeave.bind(this),this.onSpawn=this.onSpawn.bind(this),this.handler.game.on("tick",this.onTick).on("join",this.onJoin).on("leave",this.onLeave).on("spawn",this.onSpawn);for(const t of this.handler.game.controls)t.handle&&this.onSpawn(t)}onJoin(e){const t=new r;t.writeUInt8(2),t.writeUInt16(e.id),this.handler.ws.send(t.finalize())}onLeave(e){const t=new r;t.writeUInt8(3),t.writeUInt16(e.id),this.handler.ws.send(t.finalize())}onSpawn(e){const t=new r;t.writeUInt8(4),t.writeUInt16(e.id),t.writeUTF16String(e.name),t.writeUTF16String(e.skin),this.handler.ws.send(t.finalize())}onTick(){const e=new r;e.writeUInt8(1),e.writeFloat32(this.handler.game.engine.usage),e.writeUInt16(this.handler.game.engine.cellCount),e.writeUInt8(this.handler.game.handles),this.handler.ws.send(e.finalize())}onDisconnect(){this.handler.game.off("tick",this.onTick).off("join",this.onJoin).off("leave",this.onLeave).off("spawn",this.onSpawn)}}},{"../protocol":7,"../reader":11,"../writer":14}],11:[function(e,t){var o=String.fromCharCode;t.exports=class{constructor(e,t=!0){this.view=e,this.offset=0,this.le=t}get length(){return this.view.byteLength}readUInt8(){return this.view.getUint8(this.offset++)}readInt8(){return this.view.getInt8(this.offset++)}readUInt16(){const e=this.view.getUint16(this.offset,this.le);return this.offset+=2,e}readInt16(){const e=this.view.getUint16(this.offset,this.le);return this.offset+=2,e}readUInt32(){const e=this.view.getUint32(this.offset,this.le);return this.offset+=4,e}readInt32(){const e=this.view.getInt32(this.offset,this.le);return this.offset+=4,e}readFloat32(){const e=this.view.getFloat32(this.offset,this.le);return this.offset+=4,e}readFloat64(){const e=this.view.getFloat64(this.offset,this.le);return this.offset+=8,e}skip(e){this.offset+=e}readUTF8String(){const e=[];for(;this.offset<this.view.byteLength;){const t=this.readUInt8();if(!t)break;e.push(o(t))}return e.join("")}readUTF16String(){const e=[];for(;this.offset<this.view.byteLength;){const t=this.readUInt16();if(!t)break;e.push(o(t))}return e.join("")}}},{}],12:[function(e,t){const o=e("../game/handle");class n extends o{constructor(e,t){super(e),this.ws=t,this.protocol=null}onSpawn(e){this.protocol&&this.protocol.onSpawn(e)}onUpdate(){this.protocol&&this.protocol.onUpdate()}onMessage(e){try{if(!this.protocol){const t=n.protocols.find(t=>t.handshake(e));t?this.protocol=new t(this):(console.log("Message received: ",e.buffer),this.ws.end(1003,"Ambiguous protocol"))}else this.protocol.onMessage(e)}catch(t){console.error(t)}}onChat(e,t){this.protocol&&this.protocol.onChat(e,t)}onDisconnect(e,t){this.protocol&&this.protocol.onDisconnect(e,t)}}n.protocols=e("./protocols"),t.exports=n},{"../game/handle":3,"./protocols":8}],13:[function(e,t){const o=e("./socket"),n=e("./fake-socket"),r=e("./protocols/web-console"),s=e("./chat"),i=e("../game");o.protocols.push(r),t.exports=class{constructor(){this.game=new i,this.ports=new Set}open(){self.onconnect=t=>{const e=t.source,r=new n(e);r.sock=new o(this.game,r),this.ports.add(e),r.onmessage=t=>{e.lastMessage=Date.now(),r.sock.onMessage(t)},r.onclose=(t,o)=>{r.sock.controller?console.log(`Disconnected: (handle#${r.sock.controller.id}) code: ${t}, message: ${o}`):console.log(`Disconnected: code: ${t}, message: ${o}`),this.ports.delete(e),r.sock.onDisconnect(t,o)}},this.game.chat=new s(this.game),setInterval(()=>{for(const e of this.ports)3e3<Date.now()-e.lastMessage&&e.ws.end(1001,"No PING received")},1e3)}close(){for(const e of this.ports)e.close()}}},{"../game":4,"./chat":5,"./fake-socket":6,"./protocols/web-console":10,"./socket":12}],14:[function(e,t){const o=new DataView(new ArrayBuffer(1048576));t.exports=class{constructor(e=!0){this.offset=0,this.le=e}writeUInt8(e){o.setUint8(this.offset++,e)}writeInt8(e){o.setInt8(this.offset++,e)}writeUInt16(e){o.setUint16(this.offset,e,this.le),this.offset+=2}writeInt16(e){o.setInt16(this.offset,e,this.le),this.offset+=2}writeUInt32(e){o.setUint32(this.offset,e,this.le),this.offset+=4}writeInt32(e){o.setInt32(this.offset,e,this.le),this.offset+=4}writeFloat32(e){o.setFloat32(this.offset,e,this.le),this.offset+=4}writeFloat64(e){o.setFloat64(this.offset,e,this.le),this.offset+=8}writeUTF8String(e){for(let t=0;t<e.length;t++)this.writeUInt8(e.charCodeAt(t));this.writeUInt8(0)}writeUTF16String(e){for(let t=0;t<e.length;t++)this.writeUInt16(e.charCodeAt(t));this.writeUInt16(0)}finalize(){return o.buffer.slice(0,this.offset)}}},{}],15:[function(e,t){const o=1,n=2,r=8,s=32,i={252:"Mother Cell",253:"Virus",254:"Pellet",255:"Ejected"};t.exports=class{constructor(e,t){this.__root=null,this.view=e,this.id=t}get x(){return this.view.getFloat32(0,!0)}set x(e){this.view.setFloat32(0,e,!0)}get y(){return this.view.getFloat32(4,!0)}set y(e){this.view.setFloat32(4,e,!0)}get r(){return this.view.getFloat32(8,!0)}set r(e){this.view.setFloat32(8,e,!0)}get type(){return this.view.getUint8(12)}set type(e){this.view.setUint8(12,e)}get flags(){return this.view.getUint8(13)}remove(){this.view.setUint8(13,o|s)}resetFlag(){this.isDead?this.view.setUint8(13,r|o):this.view.setUint8(13,o)}get exists(){return this.view.getUint8(13)&o}get isUpdated(){return this.view.getUint8(13)&n}set updated(e){e&&this.view.setUint8(13,this.view.getUint8(13)|n)}get isInside(){this.view.getUint8(13)&4}get isDead(){return this.view.getUint8(13)&r}get shouldAuto(){return this.view.getUint8(13)&16}get shouldRemove(){return this.view.getUint8(13)&s}set merge(e){e&&this.view.setUint8(13,this.view.getUint8(13)|64)}get popped(){return this.view.getUint8(13)&128}get eatenBy(){return this.view.getUint16(14,!0)}get age(){return this.view.getUint32(16,!0)}get boostX(){return this.view.getFloat32(20,!0)}set boostX(e){this.view.setFloat32(20,e,!0)}get boostY(){return this.view.getFloat32(24,!0)}set boostY(e){this.view.setFloat32(24,e,!0)}get boost(){return this.view.getFloat32(28,!0)}set boost(e){this.view.setFloat32(28,e,!0)}toString(){const e=i[this.type];return`Cell#${this.id}[type=${e?`${e}(${this.type})`:`Player#${this.type}`},x=${this.x.toFixed(2)},y=${this.y.toFixed(2)},r=${this.r.toFixed(2)},mass=${(this.r*this.r/1e5).toFixed(1)}k,flags=${this.flags.toString(2).padStart(8,"0")}]`}}},{}],16:[function(require,module,exports){var _Mathmin=Math.min,_Mathsqrt=Math.sqrt;"undefined"==typeof performance&&eval(`global.performance = require("perf_hooks").performance;`);const Cell=require("./cell"),QuadTree=require("./quadtree"),Controller=require("../game/controller"),DefaultSettings={TPS:25,MAX_CELL_PER_TICK:50,CELL_LIMIT:65536,QUADTREE_MAX_ITEMS:16,QUADTREE_MAX_LEVEL:16,MAP_HW:8191,MAP_HH:8191,SAFE_SPAWN_TRIES:64,SAFE_SPAWN_RADIUS:1.5,PELLET_COUNT:1e3,PELLET_SIZE:10,VIRUS_COUNT:30,VIRUS_SIZE:100,VIRUS_FEED_TIMES:7,VIRUS_SPLIT_BOOST:780,VIRUS_MONOTONE_POP:!1,MOTHER_CELL_COUNT:0,MOTHER_CELL_SIZE:149,PLAYER_SPEED:1,PLAYER_SPAWN_DELAY:3e3,PLAYER_DECAY_SPEED:.001,PLAYER_DECAY_MIN_SIZE:1e3,PLAYER_AUTOSPLIT_SIZE:1500,PLAYER_MAX_CELLS:16,PLAYER_SPAWN_SIZE:32,PLAYER_SPLIT_BOOST:780,PLAYER_SPLIT_DIST:40,PLAYER_SPLIT_CAP:255,PLAYER_MIN_SPLIT_SIZE:60,PLAYER_MIN_EJECT_SIZE:60,PLAYER_NO_MERGE_DELAY:15,PLAYER_NO_COLLI_DELAY:13,PLAYER_MERGE_TIME:1,PLAYER_MERGE_INCREASE:.02,PLAYER_MERGE_NEW_VER:!0,PLAYER_VIEW_SCALE:1,PLAYER_DEAD_DELAY:5,EJECT_DISPERSION:.3,EJECT_SIZE:38,EJECT_LOSS:43,EJECT_BOOST:780,EJECT_DELAY:80,WORLD_RESTART_MULT:.75,WORLD_KILL_OVERSIZE:!1,EAT_OVERLAP:3,EAT_MULT:1.140175425099138},DEAD_CELL_TYPE=251,MOTHER_CELL_TYPE=252,VIRUS_TYPE=253,PELLET_TYPE=254,EJECTED_TYPE=255,BYTES_PER_CELL=32;module.exports=class{constructor(e){this.game=e,this.options=Object.assign({},DefaultSettings)}setOptions(e){Object.assign(this.options,e),this.counters=Array.from({length:256},()=>new Set),this.shouldRestart=!1,this.__next_cell_id=1}async init(e){if(!this.wasm){this.__start=performance.now(),this.__ltick=performance.now(),this.memory=new WebAssembly.Memory({initial:1e3});const t=await WebAssembly.instantiate(e,{env:{memory:this.memory,console_log:e=>{250<this.cells[e].type}}});this.wasm=t.instance.exports,this.bindBuffers()}}bindBuffers(){new Uint32Array(this.memory.buffer).fill(0),this.cells=Array.from({length:this.options.CELL_LIMIT},(e,t)=>new Cell(new DataView(this.memory.buffer,t*BYTES_PER_CELL,BYTES_PER_CELL),t)),this.cellCount=0,this.tree=new QuadTree(this.cells,0,0,this.options.MAP_HW,this.options.MAP_HH,this.options.QUADTREE_MAX_LEVEL,this.options.QUADTREE_MAX_ITEMS),this.indices=0,this.indicesPtr=BYTES_PER_CELL*this.options.CELL_LIMIT,this.resolveIndices=new DataView(this.memory.buffer,this.indicesPtr),this.treePtr=0,this.treeBuffer=null}start(){if(this.updateInterval)return;this.__ltick=performance.now();const e=1e3/this.options.TPS;this.updateInterval=setInterval(()=>{const t=performance.now();this.tick((t-this.__ltick)/e),this.__ltick=t,this.usage=(performance.now()-t)/e,this.game.emit("tick")},e)}stop(){this.updateInterval&&clearInterval(this.updateInterval),this.updateInterval=null}get stopped(){return!this.updateInterval}get __tick(){return Date.now()-this.__start}tick(e=1){var t=Math.PI,o=Math.round,n=Math.max,r=Math.pow,s=Math.cos,i=Math.sin,l=Math.atan2,a=Math.SQRT2;if(this.treePtr)for(const e in this.game.controls){const t=this.game.controls[e];t.handle&&t.handle.onUpdate()}for(let t=0;t<this.options.MAX_CELL_PER_TICK&&this.counters[PELLET_TYPE].size<this.options.PELLET_COUNT;t++){const e=this.getSafeSpawnPoint(this.options.PELLET_SIZE);this.newCell(e[0],e[1],this.options.PELLET_SIZE,PELLET_TYPE)}for(let t=0;t<this.options.MAX_CELL_PER_TICK&&this.counters[VIRUS_TYPE].size<this.options.VIRUS_COUNT;t++){const e=this.getSafeSpawnPoint(this.options.VIRUS_SIZE);this.newCell(e[0],e[1],this.options.VIRUS_SIZE,VIRUS_TYPE)}for(let t=0;t<this.options.MAX_CELL_PER_TICK&&this.counters[MOTHER_CELL_TYPE].size<this.options.MOTHER_CELL_COUNT;t++){const e=this.getSafeSpawnPoint(this.options.MOTHER_CELL_SIZE);this.newCell(e[0],e[1],this.options.MOTHER_CELL_SIZE,MOTHER_CELL_TYPE)}const _=this.__tick;for(const t in this.game.controls){const e=this.game.controls[t];if(!e.handle)continue;for(let o=this.options.PLAYER_SPLIT_CAP;0<e.splitAttempts&&0<o--;){for(const o of[...this.counters[t]]){const n=this.cells[o];if(this.counters[t].size>=this.options.PLAYER_MAX_CELLS)break;if(n.r<this.options.PLAYER_MIN_SPLIT_SIZE)continue;let r=e.mouseX-n.x,s=e.mouseY-n.y,i=_Mathsqrt(r*r+s*s);1>i?(r=1,s=0,i=1):(r/=i,s/=i),this.splitFromCell(n,n.r/a,r,s,this.options.PLAYER_SPLIT_BOOST)}e.splitAttempts--}if(_>=e.lastEjectTick+this.options.EJECT_DELAY&&(0<e.ejectAttempts--||e.ejectMarco)){const o=this.options.EJECT_LOSS*this.options.EJECT_LOSS;for(const n of[...this.counters[t]]){const t=this.cells[n];if(t.r<this.options.PLAYER_MIN_EJECT_SIZE)continue;let r=e.mouseX-t.x,_=e.mouseY-t.y,p=_Mathsqrt(r*r+_*_);1>p?(r=1,_=0,p=1):(r/=p,_/=p);const d=t.x+r*t.r,E=t.y+_*t.r,c=l(r,_)-this.options.EJECT_DISPERSION+2*Math.random()*this.options.EJECT_DISPERSION;this.newCell(d,E,this.options.EJECT_SIZE,EJECTED_TYPE,i(c),s(c),this.options.EJECT_BOOST),t.r=_Mathsqrt(t.r*t.r-o),t.updated=!0}e.lastEjectTick=_}if(!this.counters[t].size&&!e.spawn){e.viewportX=0,e.viewportY=0,e.viewportHW=960,e.viewportHH=540;continue}let o=0,p=0,d=0,E=0,c=0,L=0,f=0,w=this.options.MAP_HW,m=-this.options.MAP_HW,I=this.options.MAP_HH,P=-this.options.MAP_HH;for(const e of this.counters[t]){const t=this.cells[e];E+=t.x*t.r,c+=t.y*t.r,w=t.x<w?t.x:w,m=t.x>m?t.x:m,I=t.y<I?t.y:I,P=t.y>P?t.y:P,L+=t.r*t.r/100,o+=t.r}if(o=o||1,f=r(this.counters[t].size+50,.1),e.viewportX=E/o,e.viewportY=c/o,o=(f+1)*_Mathsqrt(100*L),p=d=n(o,4e3),p=n(p,1.75*(e.viewportX-w)),p=n(p,1.75*(m-e.viewportX)),d=n(d,1.75*(e.viewportY-I)),d=n(d,1.75*(P-e.viewportY)),e.viewportHW=p*this.options.PLAYER_VIEW_SCALE,e.viewportHH=d*this.options.PLAYER_VIEW_SCALE,e.score=L,e.maxScore=L>e.maxScore?L:e.maxScore,e.score>this.options.MAP_HH*this.options.MAP_HW/100*this.options.WORLD_RESTART_MULT)if(this.options.WORLD_KILL_OVERSIZE){for(const e of this.counters[t])this.cells[e].remove();this.counters[t].clear()}else this.shouldRestart=!0;if(e.spawn&&(_<=this.options.PLAYER_SPAWN_DELAY||_>=e.lastSpawnTick+this.options.PLAYER_SPAWN_DELAY)){e.spawn=!1,e.lastSpawnTick=_,this.kill(e.id);const o=this.getSafeSpawnPoint(this.options.PLAYER_SPAWN_SIZE);this.newCell(o[0],o[1],this.options.PLAYER_SPAWN_SIZE,~~t);for(const t of this.game.controls)t.handle&&(e.handle.onSpawn(t),e!=t&&t.handle.onSpawn(e));this.game.emit("spawn",e),console.log(`Spawned controller#${e.id} at x: ${o[0]}, y: ${o[1]}`)}else e.spawn=!1;e.handle.onUpdate(),e.alive=!this.counters[t].size}this.wasm.update(0,this.treePtr,e);const p=o(25*this.options.PLAYER_MERGE_TIME);for(const t in this.game.controls){const s=this.game.controls[t];if(s.handle)for(const i of this.counters[t]){const t=this.cells[i];if(0<this.options.PLAYER_MERGE_TIME){const e=o(25*t.r*this.options.PLAYER_MERGE_INCREASE),r=n(this.options.PLAYER_NO_MERGE_DELAY,this.options.PLAYER_MERGE_NEW_VER?n(p,e):p+e);t.merge=t.age>=r}else t.merge=t.age>=this.options.PLAYER_NO_MERGE_DELAY;let l=s.mouseX-t.x,a=s.mouseY-t.y;const _=_Mathsqrt(l*l+a*a);if(1>_)continue;l/=_,a/=_;const d=88*r(t.r,-.4396754)*this.options.PLAYER_SPEED,E=_Mathmin(d,_)*e;t.x+=l*E,t.y+=a*E}}this.wasm.decay_and_auto(0,this.treePtr,e,this.options.PLAYER_AUTOSPLIT_SIZE,this.options.PLAYER_DECAY_SPEED,this.options.PLAYER_DECAY_MIN_SIZE);for(const o of this.cells)if(o.shouldAuto){const e=1+this.options.PLAYER_MAX_CELLS-this.counters[o.type].size;if(0>=e)continue;const n=_Mathmin(Math.ceil(o.r*o.r/this.options.PLAYER_AUTOSPLIT_SIZE/this.options.PLAYER_AUTOSPLIT_SIZE),e),r=_Mathmin(_Mathsqrt(o.r*o.r/n),this.options.PLAYER_AUTOSPLIT_SIZE);for(let e=1;e<n;e++){const e=2*Math.random()*t;this.splitFromCell(o,r,i(e),s(e),this.options.PLAYER_SPLIT_BOOST)}o.r=r,o.updated=!0}this.wasm.edge_check(0,this.treePtr,-this.options.MAP_HW,this.options.MAP_HW,-this.options.MAP_HH,this.options.MAP_HH);for(const t of this.cells)t.exists&&(!(250<t.type)||t.isUpdated)&&this.tree.update(t);this.sortIndices(),this.serialize();const d=_Mathsqrt(this.options.VIRUS_SIZE*this.options.VIRUS_SIZE+this.options.EJECT_SIZE*this.options.EJECT_SIZE*this.options.VIRUS_FEED_TIMES);this.wasm.resolve(0,this.indicesPtr,this.treePtr,this.treePtr,this.stackPtr,this.options.PLAYER_NO_MERGE_DELAY,this.options.PLAYER_NO_COLLI_DELAY,this.options.EAT_OVERLAP,this.options.EAT_MULT,d,this.options.TPS*this.options.PLAYER_DEAD_DELAY);for(const o of this.cells)if(o.exists)if(o.shouldRemove)this.tree.remove(o),this.counters[o.type].delete(o.id),this.cellCount--;else if(!o.popped)o.updated&&this.tree.update(o);else if(o.type==VIRUS_TYPE){o.r=this.options.VIRUS_SIZE,this.tree.update(o);const e=l(o.boostX,o.boostY);this.newCell(o.x,o.y,this.options.VIRUS_SIZE,VIRUS_TYPE,i(e),s(e),this.options.VIRUS_SPLIT_BOOST)}else{const e=this.distributeCellMass(o);for(const n of e){const e=2*Math.random()*t;this.splitFromCell(o,_Mathsqrt(100*n),i(e),s(e),this.options.PLAYER_SPLIT_BOOST)}}this.treePtr=BYTES_PER_CELL*this.options.CELL_LIMIT,this.treeBuffer=new DataView(this.memory.buffer,this.treePtr),this.serialize(),this.leaderboard=this.game.controls.filter(e=>e.score).sort((e,t)=>t.score-e.score)}kill(e){for(const t of this.counters[e]){const e=this.cells[t],o=this.newCell(e.x,e.y,e.r,DEAD_CELL_TYPE,e.boostX,e.boostY,e.boost,!1);this.tree.swap(e,o),e.remove()}this.counters[e].clear()}splitFromCell(e,t,o,n,r){e.r=_Mathsqrt(e.r*e.r-t*t),e.updated=!0;const s=e.x+this.options.PLAYER_SPLIT_DIST*o,i=e.y+this.options.PLAYER_SPLIT_DIST*n;this.newCell(s,i,t,e.type,o,n,r)}distributeCellMass(e){var t=Math.floor;let o=this.options.PLAYER_MAX_CELLS-this.counters[e.type].size;if(0>=o)return[];let n=this.options.PLAYER_MIN_SPLIT_SIZE;n=n*n/100;const r=e.r*e.r/100;if(this.options.VIRUS_MONOTONE_POP){const e=_Mathmin(t(r/n),o);return Array(e).fill(r/(e+1))}if(r/o<n){let e=2,t=NaN;for(;(t=r/(e+1))>=n&&2*e<=o;)e*=2;return Array(e).fill(t)}const s=[];let i=r/2,l=r/2;for(;0<o&&!(i/o<n);){for(;i>=l&&1<o;)i/=2;s.push(i),l-=i,o--}return i=l/o,s.concat(Array(o).fill(i))}newCell(e,t,o,n,r=0,s=0,i=0,l=!0){if(this.cellCount>=this.options.CELL_LIMIT-1)return this.stop(),console.log("CAN NOT SPAWN NEW CELL: "+this.cellCount);for(;this.cells[this.__next_cell_id].exists;)this.__next_cell_id=(this.__next_cell_id+1)%this.options.CELL_LIMIT||1;const a=this.cells[this.__next_cell_id];return a.x=e,a.y=t,a.r=o,a.type=n,a.boostX=r,a.boostY=s,a.boost=i,a.resetFlag(),l&&this.tree.insert(a),this.counters[a.type].add(a.id),this.cellCount++,a}randomPoint(e){const t=this.options.MAP_HW-e,o=this.options.MAP_HH-e;return[2*Math.random()*t-t,2*Math.random()*o-o]}getSafeSpawnPoint(e){if(!this.treePtr)return this.randomPoint(e);for(let t=this.options.SAFE_SPAWN_TRIES;--t;){const t=this.randomPoint(e);if(0<this.wasm.is_safe(0,t[0],t[1],e*this.options.SAFE_SPAWN_RADIUS,this.treePtr,this.stackPtr))return t}return this.randomPoint(e)}sortIndices(){let e=0;for(let t=0;t<this.counters.length;t++)if(t!=PELLET_TYPE)if(250<t)for(const o of this.counters[t])this.resolveIndices.setUint16(e,o,!0),e+=2;else[...this.counters[t]].sort((e,t)=>this.cells[t].r-this.cells[e].r).forEach(t=>{this.resolveIndices.setUint16(e,t,!0),e+=2});this.treePtr=this.indicesPtr+e,this.treeBuffer=new DataView(this.memory.buffer,this.treePtr)}serialize(){this.stackPtr=this.tree.serialize(this.treeBuffer)+this.treePtr}query(e){let t=this.stackPtr+4*this.options.QUADTREE_MAX_LEVEL+20;t%2&&t++;const o=this.wasm.select(0,this.treePtr,this.treePtr,this.stackPtr,t,e.viewportX-e.viewportHW,e.viewportX+e.viewportHW,e.viewportY-e.viewportHH,e.viewportY+e.viewportHH);return new Uint16Array(this.memory.buffer,t,o)}},module.exports.DefaultSettings=DefaultSettings},{"../game/controller":2,"./cell":15,"./quadtree":17}],17:[function(e,t){const o=(e,t)=>{if(e.y-e.r>t.y){if(e.x+e.r<t.x)return 0;if(e.x-e.r>t.x)return 1}else if(e.y+e.r<t.y){if(e.x+e.r<t.x)return 2;if(e.x-e.r>t.x)return 3}return-1},n=(e,t)=>e.x-e.r>t.l&&e.x+e.r<t.r&&e.y+e.r<t.t&&e.y-e.r>t.b;class r{constructor(e,t,o,n,r,s){this.__ptr=0,this.tree=e,this.root=s,this.level=s?s.level+1:1,this.x=t,this.y=o,this.hw=n,this.hh=r,this.t=o+r,this.b=o-r,this.l=t-n,this.r=t+n,this.branches=null,this.items=new Set}split(){if(this.branches||this.items.size<this.tree.maxItems||this.level>this.tree.maxLevel)return;const e=this.hw/2,t=this.hh/2;this.branches=[new r(this.tree,this.x-e,this.y+t,e,t,this),new r(this.tree,this.x+e,this.y+t,e,t,this),new r(this.tree,this.x-e,this.y-t,e,t,this),new r(this.tree,this.x+e,this.y-t,e,t,this)];for(const e of this.items){const t=this.tree.cells[e],n=o(t,this);0>n||(this.branches[n].items.add(e),t.__root=this.branches[n],this.items.delete(e))}}merge(){for(let e=this;null!=e;){if(!e.branches){e=e.root;continue}if(e.branches[0].branches||e.branches[0].items.size||e.branches[1].branches||e.branches[1].items.size||e.branches[2].branches||e.branches[2].items.size||e.branches[3].branches||e.branches[3].items.size)return;e.branches=null}}__init_ptr(){this.__ptr=this.tree.__offset,this.tree.__offset+=26+2*this.items.size,this.branches&&(this.branches[0].__init_ptr(),this.branches[1].__init_ptr(),this.branches[2].__init_ptr(),this.branches[3].__init_ptr())}__write(e){e.setFloat32(this.__ptr,this.x,!0),e.setFloat32(this.__ptr+4,this.y,!0),this.branches?(e.setUint32(this.__ptr+8,e.byteOffset+this.branches[0].__ptr,!0),e.setUint32(this.__ptr+12,e.byteOffset+this.branches[1].__ptr,!0),e.setUint32(this.__ptr+16,e.byteOffset+this.branches[2].__ptr,!0),e.setUint32(this.__ptr+20,e.byteOffset+this.branches[3].__ptr,!0)):e.setUint32(this.__ptr+8,0,!0),this.tree.__serialized+=this.items.size,e.setUint16(this.__ptr+24,this.items.size,!0);let t=this.__ptr+26;for(const o of this.items)e.setUint16(t,o,!0),t+=2;this.branches&&(this.branches[0].__write(e),this.branches[1].__write(e),this.branches[2].__write(e),this.branches[3].__write(e))}print(){console.log(`QuadNode at ${this.__ptr} has ${this.items.size} items: ${[...this.items].join(", ")}`),this.branches&&(this.branches[0].print(),this.branches[1].print(),this.branches[2].print(),this.branches[3].print())}}class s{constructor(e,t,o,n,s,i,l){this.__offset=0,this.cells=e,this.root=new r(this,t,o,n,s,null),this.maxLevel=i,this.maxItems=l,this.__serialized=0}insert(e){e.__root&&console.log("INSERTING CELL ALREADY IN QUADTREE");let t=this.root;for(;!0&&!!t.branches;){const n=o(e,t);if(0>n)break;t=t.branches[n]}e.__root=t,t.items.add(e.id),t.split()}remove(e){e.__root||console.log("REMOVING CELL NOT IN QUADTREE"),e.__root.items.delete(e.id)||console.log("ITEM NOT IN QUAD??",e.__root.items),e.__root.merge(),e.__root=null}update(e){e.__root||console.log("UPDATING CELL NOT IN QUADTREE");const t=e.__root;let r=e.__root;for(;!!r.root&&!(r=r.root,n(e,r)););for(;!0&&!!r.branches;){const t=o(e,r);if(0>t)break;r=r.branches[t]}t===r||(t.items.delete(e.id),r.items.add(e.id),e.__root=r,t.merge(),r.split())}swap(e,t){t.__root=e.__root,t.__root.items.delete(e.id),t.__root.items.add(t.id),e.__root=null}serialize(e){this.__offset=0,this.__serialized=0,this.root.__init_ptr(),this.root.__write(e);const t=this.__offset;return this.__offset=0,t}print(){this.root.print()}}s.Node=r,t.exports=s},{}],18:[function(e){const t=e("./network/sw-server"),o=new t,n=o.game.engine;n.setOptions({VIRUS_COUNT:20,PLAYER_MAX_CELLS:64,PLAYER_NO_MERGE_DELAY:22,PLAYER_NO_COLLI_DELAY:12,PLAYER_MERGE_NEW_VER:!1,PLAYER_SPLIT_CAP:4,PLAYER_MERGE_TIME:0,EJECT_SIZE:34,EJECT_LOSS:34.5,EJECT_DELAY:80,PELLET_COUNT:1e3,PLAYER_SPAWN_SIZE:1500,MAP_HW:8191,MAP_HH:8191}),o.open(),(async()=>{const e=await fetch("/static/wasm/server.wasm"),t=await e.arrayBuffer();await n.init(t),n.start(),console.log("Shared worker server running")})()},{"./network/sw-server":13}]},{},[18]);