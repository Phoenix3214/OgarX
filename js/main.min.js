(function(){function b(d,e,g){function a(j,i){if(!e[j]){if(!d[j]){var f="function"==typeof require&&require;if(!i&&f)return f(j,!0);if(h)return h(j,!0);var c=new Error("Cannot find module '"+j+"'");throw c.code="MODULE_NOT_FOUND",c}var k=e[j]={exports:{}};d[j][0].call(k.exports,function(b){var c=d[j][1][b];return a(c||b)},k,k.exports,b,d,e,g)}return e[j].exports}for(var h="function"==typeof require&&require,c=0;c<g.length;c++)a(g[c]);return a}return b})()({1:[function(require,module,exports){const Stats=require("./stats"),Mouse=require("./mouse"),State=require("./state"),Input=require("./input"),Skins=require("./skins"),Options=require("./options"),Minimap=require("./minimap"),Viewport=require("./viewport");module.exports=class{constructor(){if(this.canvas=document.getElementById("canvas"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.showing=!0,this.stats=new Stats,this.mouse=new Mouse,this.state=new State,this.viewport=new Viewport,this.server="",navigator.userAgent.includes("Chrome")){this.worker=new Worker("js/renderer.min.js");const a=this.canvas.transferControlToOffscreen(),b={offscreen:a,stats:this.stats.sharedBuffer,mouse:this.mouse.sharedBuffer,state:this.state.sharedBuffer,viewport:this.viewport.sharedBuffer};this.worker.postMessage(b,[a]),this.worker.onmessage=a=>{const{data:b}=a;"ready"===b.event&&(this.ready=!0),"chat"===b.event&&this.onChat(b.pid,b.player,b.message),"leaderboard"===b.event&&this.onLeaderboard(b.lb),"connect"===b.event&&this.onConnect(b.server),"disconnect"===b.event&&this.onDisconnect(),"error"===b.event&&this.onError(b.message||""),"minimap"===b.event&&this.minimap.onData(b.minimap)},this.registerEvents(),this.resize(),this.initUIComponents()}else navigator.userAgent.includes("Firefox")&&fetch("js/renderer.min.js").then(a=>a.text()).then(code=>{eval(code),this.renderer=new Renderer(this.canvas),this.renderer.stats=this.stats,this.renderer.mouse=this.mouse,this.renderer.state=this.state,this.renderer.viewport=this.viewport}).then(()=>this.renderer.initEngine()).then(()=>{this.registerEvents(),this.resize(),this.initUIComponents()})}show(a=this.hudElem){a.classList.add("fade-in"),a.classList.remove("fade-out"),a.hidden=!1,a.focus()}hide(a=this.hudElem){a.classList.remove("fade-in"),a.classList.add("fade-out"),setTimeout(()=>a.hidden=!0,250),a.blur()}toggle(a=this.hudElem){a.hidden?this.show(a):this.hide(a)}resize(){var a=Math.floor;let b=a(this.state.resolution*window.devicePixelRatio*window.innerWidth),c=a(this.state.resolution*window.devicePixelRatio*window.innerHeight);this.viewport.width=b,this.viewport.height=c,this.canvas.style.width=window.innerWidth+"px",this.canvas.style.height=window.innerHeight+"px"}registerEvents(){window.onresize=this.resize.bind(this),this.resize(),document.addEventListener("contextmenu",a=>a.preventDefault()),this.input=new Input(this),this.options=new Options(this),this.state.focused=1,window.addEventListener("keydown",a=>this.input.keyDown(a)),window.addEventListener("keyup",a=>this.input.keyUp(a)),window.addEventListener("blur",()=>this.input.blur()),window.addEventListener("focus",()=>this.input.focus()),window.addEventListener("mousedown",a=>this.input.keyDown({key:`MOUSE ${a.button}`})),window.addEventListener("mouseup",a=>this.input.keyUp({key:`MOUSE ${a.button}`})),window.addEventListener("mousemove",a=>{this.mouse.x=~~(a.clientX*window.devicePixelRatio*this.state.resolution),this.mouse.y=~~(a.clientY*window.devicePixelRatio*this.state.resolution)}),canvas.addEventListener("wheel",a=>{a.ctrlKey||this.mouse.updateScroll(a.deltaY)},{passive:!0})}updateSkin(a=!1){if(!this.skin)return void(this.skinElem.src="/static/img/skin.png");console.log(`Loading skin from ${this.skin}`);const b=new Image;b.onload=()=>{this.skins.current=this.skinElem.src=this.skin},a||(b.onerror=()=>{this.onError(`Failed to load skin "${this.skin}"`),this.skinElem.src="/static/img/skin.png"}),b.src=this.skin}initUIComponents(){if(this.hudElem=document.getElementById("hud"),this.skinElem=document.getElementById("skin"),this.skinInput=document.getElementById("skin-input"),this.serverInput=document.getElementById("server-input"),this.nameInput=document.getElementById("name-input"),this.minimap=new Minimap(this),this.skins=new Skins(this),this.skinInput.value=this.skins.current,this.skinInput.addEventListener("blur",()=>this.updateSkin()),this.playButton=document.getElementById("play"),this.playButton.addEventListener("click",()=>{this.hide(),this.spawn(),this.playButton.blur()}),this.spectateButton=document.getElementById("spectate"),this.chatElem=document.getElementById("chat"),this.chatInput=document.getElementById("chat-input"),this.chatInput.addEventListener("keydown",a=>{if(a.stopPropagation(),"Enter"==a.key){const a=this.chatInput.value.trim();a&&(this.sendChat(a),this.chatInput.value=""),this.hide(this.chatInput),this.canvas.focus()}}),this.chatElem.addEventListener("focus",()=>{this.chatElem.blur(),this.canvas.focus()}),this.chatElem.addEventListener("wheel",a=>a.stopPropagation(),{passive:!0}),this.serverInput.value="Select Server",this.serverInput.addEventListener("click",()=>this.serverAccordion.toggle(0,!0)),this.nameInput.value=localStorage.getItem("ogarx-name")||"",this.nameInput.autocomplete=Math.random(),this.skinInput.autocomplete=Math.random(),this.serverAccordion=UIkit.accordion("#server-accordion"),this.updateSkin(!0),this.chatInput.addEventListener("blur",()=>this.hide(this.chatInput)),this.lbElem=document.getElementById("leaderboard-data"),/^https?\:\/\/localhost$/.test(window.origin)){const a=document.createElement("button");a.classList.add("servers","uk-inline"),a.setAttribute("server","localhost:3000/mega"),a.innerText="Dev Mega",document.getElementById("server-list").append(a);const b=document.createElement("button");b.classList.add("servers","uk-inline"),b.setAttribute("server","localhost:3001/covid"),b.innerText="Dev Covid",document.getElementById("server-list").append(b);const c=document.createElement("button");c.classList.add("servers","uk-inline"),c.setAttribute("server","localhost:3002/omega"),c.innerText="Dev Omega",document.getElementById("server-list").append(c),window.hud=this}document.querySelectorAll(".servers").forEach(a=>{a.addEventListener("click",()=>{this.server=a.textContent;const b=a.attributes.getNamedItem("server").value;this.connect(b)})}),this.pingElem=document.getElementById("ping"),this.fpsElem=document.getElementById("fps"),this.bwElem=document.getElementById("bandwidth"),this.mycellsElem=document.getElementById("mycells"),this.linelockElem=document.getElementById("linelock"),this.updateInterval=setInterval(()=>{this.pingElem.innerText=this.stats.ping,this.fpsElem.innerText=this.stats.fps;const a=this.stats.bandwidth/1024;this.bwElem.innerText=1024>a?`${~~a}kbs`:`${(a/1024).toFixed(1)}mbs`,this.mycellsElem.innerText=this.stats.mycells,this.linelockElem.innerText=this.stats.linelocked?"LOCKED":"UNLOCKED",this.stats.linelocked?this.linelockElem.classList.add("text-danger"):this.linelockElem.classList.remove("text-danger")},100)}sendChat(a){this.worker&&this.worker.postMessage({chat:a})}onChat(a,b,c){const d=document.createElement("p");d.textContent=a?`${b.name||"Unnamed"}: ${c}`:c,d.classList.add(`player-${a}`),this.chatElem.appendChild(d),this.chatElem.scrollTo(0,this.chatElem.scrollHeight)}onLeaderboard(a){const{players:b,rank:c,me:d}=a;for(const d in this.lbElem.innerHTML="",b){const a=document.createElement("p");a.textContent=`${~~d+1}. ${b[d]?b[d].name:""}`,d==c&&a.classList.add("me"),this.lbElem.appendChild(a)}if(!b[c]&&65535!=c){const a=document.createElement("p");a.textContent=`${c+1}. ${d.name||""}`,a.classList.add("me"),this.lbElem.appendChild(a)}}get skin(){return this.skinInput.value}get name(){return this.nameInput.value}connect(a){a=a.trim(),"local"==a?this.connectToLocal():this.connectToURL(`${window.location.protocol.replace("http","ws")}//${a}`)}onError(a){UIkit.notification({message:a,status:"danger",timeout:3e3})}onConnect(a="Server"){this.serverInput.value=this.server,this.show(this.playButton),this.show(this.spectateButton),this.chatElem.innerHTML="",this.onChat(0,null,"Connected"),this.show(document.getElementById("stats1")),this.show(document.getElementById("stats2")),this.show(document.getElementById("leaderboard")),document.getElementById("server-name").innerText=a,this.serverAccordion.toggle(0,!0)}onDisconnect(){this.lbElem.innerHTML="",this.chatElem.innerHTML="",this.hide(this.playButton),this.hide(this.spectateButton),this.show(),this.onError("Disconnected"),this.hide(document.getElementById("stats1")),this.hide(document.getElementById("stats2")),this.hide(document.getElementById("leaderboard")),document.getElementById("server-name").innerText="",this.serverAccordion.toggle(0,!0)}spawn(){const a=this.name,b=this.skin;if(localStorage.setItem("ogarx-name",a),this.worker)this.worker.postMessage({spawn:!0,name:a,skin:b});else{const c=this.renderer.protocol;c.once("open",()=>c.spawn(a,b))}}connectToLocal(){if(this.sw=new SharedWorker("js/sw.min.js","ogar-x-server"),this.worker)this.worker.postMessage({connect:this.sw.port,name:this.name,skin:this.skin},[this.sw.port]);else{const a=this.renderer.protocol;a.connect(sw.port,this.name,this.skin)}}connectToURL(a){this.worker?this.worker.postMessage({connect:a,name:this.name,skin:this.skin}):this.renderer.protocol.connect(a,this.name,this.skin)}}},{"./input":2,"./minimap":4,"./mouse":5,"./options":6,"./skins":7,"./state":8,"./stats":9,"./viewport":10}],2:[function(a,b){const c=["Feed","Split","Double Split","Triple Split","Quad Split","Line Lock","Respawn"],d={" ":"SPACE"};b.exports=class{constructor(a){this.hud=a;try{const a=JSON.parse(localStorage.getItem("ogarx-keys"));if(!Array.isArray(a)||a.length!=c.length||!a.every(a=>"string"==typeof a))throw new Error("Error parsing keybinds, resetting");this.keys=a}catch(a){console.error(a),this.keys=["w"," ","g","z","q","f","n"]}this.menuElem=document.getElementById("key-menu"),this.pressing=new Set,this.updateKeys(),this.save()}save(){localStorage.setItem("ogarx-keys",JSON.stringify(this.keys))}updateKeys(){const a=document.getElementById("keys");for(const e in a.innerHTML="",this.labels=[],c){const f=document.createElement("span"),g=this.keys[e].toUpperCase();f.textContent=`${c[e]}`;const h=document.createElement("b");h.innerText=(d[g]||g).toUpperCase(),h.classList.add("selectable"),a.appendChild(f),a.appendChild(h),this.labels.push(h),h.addEventListener("mouseenter",()=>{this.hovered=h}),h.addEventListener("mouseleave",()=>{this.hovered=null}),h.addEventListener("click",a=>{this.setKey(h,`MOUSE ${a.button}`),a.preventDefault(),a.stopPropagation()})}}setKey(a=this.hovered,b=""){const c=this.labels.indexOf(a);a.innerText=(d[b]||b).toUpperCase(),this.keys[c]=b,this.save()}keyDown(a){if(!a.ctrlKey&&("Tab"==a.key&&a.preventDefault(),"Escape"==a.key&&this.hud.toggle(),"Enter"==a.key&&this.hud.toggle(this.hud.chatInput),!this.pressing.has(a.key))){this.pressing.add(a.key);const b=a.key;this.hovered&&this.setKey(this.hovered,b);const d=c[this.keys.indexOf(b)];if(d){const a=this.hud.state;"Feed"===d?a.macro=1:"Split"===d?a.splits=1:"Double Split"===d?a.splits=2:"Triple Split"===d?a.splits=3:"Quad Split"===d?a.splits=4:"Line Lock"===d?a.lineLock=1:"Respawn"===d?a.respawn=1:void 0}}}keyUp(a){if(a.ctrlKey)return;this.pressing.delete(a.key);const b=a.key,d=c[this.keys.indexOf(b)];if(d){const a=this.hud.state;"Feed"===d?a.macro=0:void 0}}blur(){this.hud.state.focused=0}focus(){this.hud.state.focused=1;for(const a of this.pressing)this.keyUp(a);this.pressing.clear()}}},{}],3:[function(a){const b=a("./hud");window.onload=()=>window.app=new b},{"./hud":1}],4:[function(a,b){const c="http://www.w3.org/2000/svg",d=25;b.exports=class{constructor(a,b=512){this.hud=a,this.dim=b,this.circles=document.getElementById("minimap").firstElementChild,this.texts=document.getElementById("minimap").lastElementChild,this.circles.setAttribute("viewBox",`${-d} ${-d} ${b+d} ${b+d}`),this.texts.setAttribute("viewBox",`${-d} ${-d} ${b+d} ${b+d}`),this.nodes=new Map}onData(a){for(const[b,[c,d]]of[...this.nodes.entries()])a.some(a=>a.id==b)||(c.remove(),d.remove(),this.nodes.delete(b));for(const b of a){let a=this.nodes.get(b.id),e=a&&a[0],f=a&&a[1];a||(e=document.createElementNS(c,"circle"),e.classList.add("minimap-node"),f=document.createElementNS(c,"text"),f.classList.add("minimap-text"),f.setAttribute("fill","#eee"),this.circles.appendChild(e),this.texts.appendChild(f),this.nodes.set(b.id,[e,f]));f.textContent=b.name,f.setAttribute("x",b.x*this.dim),f.setAttribute("y",(1-b.y)*this.dim-d),e.setAttribute("fill",b.me?"#93a7e1":"#eee"),e.setAttribute("r",2*Math.max(Math.log2(b.score)/2,3)),e.setAttribute("cx",b.x*this.dim),e.setAttribute("cy",(1-b.y)*this.dim)}}}},{}],5:[function(a,b){b.exports=class{constructor(){this.setBuffer()}setBuffer(a){a||(self.SharedArrayBuffer?a=new SharedArrayBuffer(12):a=new ArrayBuffer(12)),this.sharedBuffer=a,this.buffer=new Int32Array(this.sharedBuffer)}get x(){return Atomics.load(this.buffer,0)}set x(a){Atomics.store(this.buffer,0,a)}get y(){return Atomics.load(this.buffer,1)}set y(a){Atomics.store(this.buffer,1,a)}get scroll(){return Atomics.load(this.buffer,2)}set scroll(a){Atomics.store(this.buffer,2,a)}updateScroll(a){Atomics.add(this.buffer,2,a)}resetScroll(){return Atomics.exchange(this.buffer,2,0)}}},{}],6:[function(a,b){const c={zoom:3,skin:1,name:1,mass:1,draw:120,quality:0},d=Object.keys(c),e={skin:["Disabled","Enabled"],name:["Disabled","Enabled"],mass:["Disabled","Short","Long"],quality:["x1.0","x0.8","x0.7","x0.6","x0.5"]};b.exports=class{constructor(a){this.hud=a;try{const a=JSON.parse(localStorage.getItem("ogarx-options"));for(const b of d)"number"!=typeof a[b]&&(a[b]=c[b]);Object.assign(this.hud.state,a)}catch(a){Object.assign(this.hud.state,c)}for(const b in e){const a=document.getElementById(`render-${b}`);a.addEventListener("click",()=>{const c=this.hud.state[b]=(this.hud.state[b]+1)%e[b].length;a.innerText=e[b][c],this.save(),"quality"==b&&this.hud.resize()}),a.innerText=e[b][this.hud.state[b]]}const b=document.getElementById("render-delay-input"),f=document.getElementById("render-delay-display"),g=()=>{this.hud.state.draw=~~b.value,f.innerText=b.value,this.save()};b.addEventListener("change",g),b.addEventListener("mousemove",g),b.value=this.hud.state.draw,g()}save(){const a={};for(const b of d)a[b]=this.hud.state[b];localStorage.setItem("ogarx-options",JSON.stringify(a))}}},{}],7:[function(a,b){b.exports=class{constructor(a){var b=Math.min;this.hud=a;let c;try{if(c=JSON.parse(localStorage.getItem("ogarx-skins")),!Array.isArray(c)||!c.every(a=>"string"==typeof a))throw new Error("Failed to load skin")}catch(a){console.error(a),c=[]}const d=localStorage.getItem("ogarx_skin");d?(localStorage.removeItem("ogarx_skin"),c.push(d)):!c.length&&c.push("");let e=b(~~localStorage.getItem("ogarx-skin-index")||0,c.length-1);for(const b in this.listElem=document.getElementById("skins"),document.getElementById("prev-skin").addEventListener("click",()=>this.prev()),document.getElementById("next-skin").addEventListener("click",()=>this.next()),this.selectedImg=null,this.elems=[],c){const a=document.createElement("div");a.classList.add("skin-item");const d=document.createElement("img");this.initImg(d),a.appendChild(d),d.onerror=()=>d.src="/static/img/skin.png",d.src=c[b],this.listElem.appendChild(a),this.elems.push(d)}this.selectedImg=this.elems[e],this.selectedImg.classList.add("selected"),this.selectedImg.addEventListener("load",()=>this.sync(),{once:!0}),document.getElementById("add-skin").addEventListener("click",()=>this.addSlot()),document.getElementById("delete-skin").addEventListener("click",()=>this.delete()),this.save()}initImg(a){a.onclick=()=>{a.classList.contains("selected")||(this.selectedImg.classList.remove("selected"),a.classList.add("selected"),this.selectedImg=a,this.sync(),this.saveIndex())}}addSlot(){const a=document.createElement("div");a.classList.add("skin-item");const b=document.createElement("img");this.initImg(b),a.appendChild(b),this.listElem.appendChild(a),b.src="/static/img/skin.png",this.elems.push(b),this.save()}delete(){if(1===this.elems.length)return this.selectedImg.src="/static/img/skin.png",this.sync(),void this.save();const a=this.index;this.selectedImg.parentNode.remove(),this.elems.splice(a,1),this.elems[a]?(this.elems[a].click(),this.save()):(this.elems[a-1].click(),this.save())}get index(){return this.elems.indexOf(this.selectedImg)}set current(a){this.current!=a&&(this.selectedImg.src=a,this.save())}get current(){return this.getUrl(this.selectedImg.src)}getUrl(a){return a.endsWith("/static/img/skin.png")?"":a}prev(){1>=this.elems.length||(this.elems[(this.index-1+this.elems.length)%this.elems.length].click(),this.sync(),this.saveIndex())}next(){1>=this.elems.length||(this.elems[(this.index+1)%this.elems.length].click(),this.sync(),this.saveIndex())}sync(){this.hud.skin!=this.current&&(this.hud.skinInput.value=this.current,this.hud.updateSkin())}saveIndex(){localStorage.setItem("ogarx-skin-index",this.index)}save(){this.saveIndex(),localStorage.setItem("ogarx-skins",JSON.stringify(this.elems.map(a=>this.getUrl(a.src))))}}},{}],8:[function(a,b){b.exports=class{constructor(){this.setBuffer(),this.quality=0}setBuffer(a){a||(self.SharedArrayBuffer?a=new SharedArrayBuffer(100):a=new ArrayBuffer(100)),this.sharedBuffer=a,this.buffer=new Int32Array(this.sharedBuffer)}get resolution(){return[1,.9,.8,.7,.6,.5][this.quality]||1}get spectate(){return Atomics.load(this.buffer,0)}set spectate(a){Atomics.store(this.buffer,0,a)}get splits(){return Atomics.load(this.buffer,1)}set splits(a){Atomics.add(this.buffer,1,a)}get ejects(){return Atomics.load(this.buffer,2)}set ejects(a){Atomics.add(this.buffer,2,a)}get macro(){return Atomics.load(this.buffer,3)}set macro(a){Atomics.store(this.buffer,3,a)}get respawn(){return Atomics.load(this.buffer,4)}set respawn(a){Atomics.store(this.buffer,4,a)}get focused(){return Atomics.load(this.buffer,5)}set focused(a){Atomics.store(this.buffer,5,a)}get lineLock(){return Atomics.load(this.buffer,6)}set lineLock(a){Atomics.store(this.buffer,6,a)}get skin(){return Atomics.load(this.buffer,7)}set skin(a){Atomics.store(this.buffer,7,a)}get name(){return Atomics.load(this.buffer,8)}set name(a){Atomics.store(this.buffer,8,a)}get mass(){return Atomics.load(this.buffer,9)}set mass(a){Atomics.store(this.buffer,9,a)}get draw(){return Atomics.load(this.buffer,10)}set draw(a){Atomics.store(this.buffer,10,a)}get zoom(){return Atomics.load(this.buffer,11)}set zoom(a){Atomics.store(this.buffer,11,a)}exchange(){return{spectate:Atomics.exchange(this.buffer,0,0),splits:Atomics.exchange(this.buffer,1,0),ejects:Atomics.exchange(this.buffer,2,0),macro:this.macro,respawn:Atomics.exchange(this.buffer,4,0),lineLock:Atomics.exchange(this.buffer,6,0)}}}},{}],9:[function(a,b){b.exports=class{constructor(){this.setBuffer()}setBuffer(a){a||(self.SharedArrayBuffer?a=new SharedArrayBuffer(28):a=new ArrayBuffer(28)),this.sharedBuffer=a,this.buffer=new Int32Array(this.sharedBuffer)}get fps(){return Atomics.load(this.buffer,0)}set fps(a){Atomics.store(this.buffer,0,a)}get ping(){return Atomics.load(this.buffer,1)}set ping(a){Atomics.store(this.buffer,1,a)}get cells(){return Atomics.load(this.buffer,2)}set cells(a){Atomics.store(this.buffer,2,a)}get text(){return Atomics.load(this.buffer,3)}set text(a){Atomics.store(this.buffer,3,a)}get bandwidth(){return Atomics.load(this.buffer,4)}set bandwidth(a){Atomics.store(this.buffer,4,a)}get mycells(){return Atomics.load(this.buffer,5)}set mycells(a){Atomics.store(this.buffer,5,a)}get linelocked(){return Atomics.load(this.buffer,6)}set linelocked(a){Atomics.store(this.buffer,6,a)}}},{}],10:[function(a,b){b.exports=class{constructor(){this.setBuffer()}setBuffer(a){a||(self.SharedArrayBuffer?a=new SharedArrayBuffer(8):a=new ArrayBuffer(8)),this.sharedBuffer=a,this.buffer=new Int32Array(this.sharedBuffer)}get width(){return Atomics.load(this.buffer,0)}set width(a){Atomics.store(this.buffer,0,a)}get height(){return Atomics.load(this.buffer,1)}set height(a){Atomics.store(this.buffer,1,a)}}},{}]},{},[3]);