(function(){function b(d,e,g){function a(j,i){if(!e[j]){if(!d[j]){var f="function"==typeof require&&require;if(!i&&f)return f(j,!0);if(h)return h(j,!0);var c=new Error("Cannot find module '"+j+"'");throw c.code="MODULE_NOT_FOUND",c}var k=e[j]={exports:{}};d[j][0].call(k.exports,function(b){var c=d[j][1][b];return a(c||b)},k,k.exports,b,d,e,g)}return e[j].exports}for(var h="function"==typeof require&&require,c=0;c<g.length;c++)a(g[c]);return a}return b})()({1:[function(require,module,exports){const Mouse=require("./mouse"),State=require("./state"),Viewport=require("./viewport");module.exports=class{constructor(){if(this.canvas=document.getElementById("canvas"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.showing=!0,this.mouse=new Mouse,this.state=new State,this.viewport=new Viewport,navigator.userAgent.includes("Chrome")){this.worker=new Worker("js/renderer.min.js");const a=this.canvas.transferControlToOffscreen(),b={offscreen:a,mouse:this.mouse.sharedBuffer,state:this.state.sharedBuffer,viewport:this.viewport.sharedBuffer};this.worker.postMessage(b,[a]),this.worker.onmessage=a=>{const{data:b}=a;"ready"===b.event&&(this.ready=!0),"chat"===b.event&&this.onChat(b.pid,b.player,b.message)},this.registerEvents(),this.resize(),this.initUIComponents()}else navigator.userAgent.includes("Firefox")&&fetch("js/renderer.min.js").then(a=>a.text()).then(code=>{eval(code),this.renderer=new Renderer(this.canvas),this.renderer.mouse=this.mouse,this.renderer.state=this.state,this.renderer.viewport=this.viewport}).then(()=>this.renderer.initEngine()).then(()=>{this.registerEvents(),this.resize(),this.initUIComponents()})}show(a=this.hudElem){a.focus(),a.style.opacity=1,a.style.zIndex=1}hide(a=this.hudElem){a.blur(),a.style.opacity=0,setTimeout(()=>a.style.zIndex=0,250)}toggle(a=this.hudElem){1==a.style.opacity?this.hide(a):this.show(a)}resize(){this.viewport.width=window.devicePixelRatio*window.innerWidth,this.viewport.height=window.devicePixelRatio*window.innerHeight,this.canvas.style.width=window.innerWidth,this.canvas.style.height=window.innerHeight}registerEvents(){window.onresize=this.resize.bind(this),this.pressing=new Set;const a=this.state;window.addEventListener("keydown",b=>{"Tab"==b.key&&b.preventDefault(),"Escape"==b.key&&this.toggle(),"Enter"==b.key&&this.toggle(this.chatInput);this.pressing.has(b.key)||("w"==b.key&&(a.macro=1)," "==b.key&&(a.splits=1),"g"==b.key&&(a.splits=2),"z"==b.key&&(a.splits=3),"q"==b.key&&(a.splits=4),"n"==b.key&&(a.respawn=1),this.pressing.add(b.key))}),window.addEventListener("keyup",b=>{"w"==b.key&&(a.macro=0),this.pressing.delete(b.key)}),window.addEventListener("blur",()=>a.focused=0),window.addEventListener("focus",()=>a.focused=1),a.focused=1,canvas.addEventListener("mousemove",a=>(this.mouse.x=a.clientX,this.mouse.y=a.clientY)),canvas.addEventListener("wheel",a=>this.mouse.updateScroll(a.deltaY),{passive:!0})}initUIComponents(){this.hudElem=document.getElementById("hud"),this.skinElem=document.getElementById("skin"),this.skinInput=document.getElementById("skin-input"),this.serverInput=document.getElementById("server-input"),this.nameInput=document.getElementById("name-input");const a=(a=!1)=>{const b=new Image;b.onload=()=>{this.skinInput.classList.remove("danger"),this.skinElem.src=this.skin},a||(b.onerror=()=>this.skinInput.classList.add("danger")),b.src=this.skin};this.skinInput.addEventListener("blur",a),this.connectButton=document.getElementById("connect"),this.connectButton.addEventListener("click",()=>{this.spawn(),this.hide(),this.connectButton.blur()}),this.chatElem=document.getElementById("chat"),this.chatInput=document.getElementById("chat-input"),this.chatInput.addEventListener("keydown",a=>{if(a.stopPropagation(),"Enter"==a.key){const a=this.chatInput.value.trim();a?(this.sendChat(a),this.chatInput.value=""):(this.hide(this.chatInput),this.canvas.focus())}}),this.chatElem.addEventListener("focus",()=>{this.chatElem.blur(),this.canvas.focus()}),this.chatElem.addEventListener("wheel",a=>a.stopPropagation()),this.serverInput.value=localStorage.getItem("ogarx_server")||"local",this.nameInput.value=localStorage.getItem("ogarx_name")||"",this.skinInput.value=localStorage.getItem("ogarx_skin")||"",a(!0)}sendChat(a){this.worker&&this.worker.postMessage({chat:a})}onChat(a,b,c){const d=document.createElement("p");d.textContent=`${b.name||"Unnamed"}: ${c}`,this.chatElem.appendChild(d),this.chatElem.scrollTo(0,this.chatElem.scrollHeight)}get skin(){return this.skinInput.value}get name(){return this.nameInput.value}get server(){return this.serverInput.value}spawn(){const a=this.server,b=this.name,c=this.skin;if("local"==a?this.connectToLocal():this.connectToURL(a),localStorage.setItem("ogarx_server",a),localStorage.setItem("ogarx_name",b),localStorage.setItem("ogarx_skin",c),this.worker)this.worker.postMessage({spawn:!0,name:b,skin:c});else{const a=this.renderer.protocol;a.once("open",()=>a.spawn(b,c))}}connectToLocal(){const a=new SharedWorker("js/sw.min.js","ogar-x-server");this.worker?this.worker.postMessage({connect:a.port},[a.port]):this.renderer.protocol.connect(a.port)}connectToURL(a){this.worker?this.worker.postMessage({connect:a}):this.renderer.protocol.connect(a)}}},{"./mouse":3,"./state":4,"./viewport":5}],2:[function(a){const b=a("./hud");window.onload=()=>window.app=new b},{"./hud":1}],3:[function(a,b){b.exports=class{constructor(){this.setBuffer()}setBuffer(a){a||(self.SharedArrayBuffer?a=new SharedArrayBuffer(12):a=new ArrayBuffer(12)),this.sharedBuffer=a,this.buffer=new Int32Array(this.sharedBuffer)}get x(){return Atomics.load(this.buffer,0)}set x(a){Atomics.store(this.buffer,0,a)}get y(){return Atomics.load(this.buffer,1)}set y(a){Atomics.store(this.buffer,1,a)}get scroll(){return Atomics.load(this.buffer,2)}set scroll(a){Atomics.store(this.buffer,2,a)}updateScroll(a){Atomics.add(this.buffer,2,a)}resetScroll(){return Atomics.exchange(this.buffer,2,0)}}},{}],4:[function(a,b){b.exports=class{constructor(){this.setBuffer()}setBuffer(a){a||(self.SharedArrayBuffer?a=new SharedArrayBuffer(6):a=new ArrayBuffer(6)),this.sharedBuffer=a,this.buffer=new Uint8Array(this.sharedBuffer)}get spectate(){return Atomics.load(this.buffer,0)}set spectate(a){Atomics.store(this.buffer,0,a)}get splits(){return Atomics.load(this.buffer,1)}set splits(a){Atomics.add(this.buffer,1,a)}get ejects(){return Atomics.load(this.buffer,2)}set ejects(a){Atomics.add(this.buffer,2,a)}get macro(){return Atomics.load(this.buffer,3)}set macro(a){Atomics.store(this.buffer,3,a)}get respawn(){return Atomics.load(this.buffer,4)}set respawn(a){Atomics.store(this.buffer,4,a)}get focused(){return Atomics.load(this.buffer,5)}set focused(a){Atomics.store(this.buffer,5,a)}exchange(){return{spectate:Atomics.exchange(this.buffer,0,0),splits:Atomics.exchange(this.buffer,1,0),ejects:Atomics.exchange(this.buffer,2,0),macro:this.macro,respawn:Atomics.exchange(this.buffer,4,0)}}}},{}],5:[function(a,b){b.exports=class{constructor(){this.setBuffer()}setBuffer(a){a||(self.SharedArrayBuffer?a=new SharedArrayBuffer(8):a=new ArrayBuffer(8)),this.sharedBuffer=a,this.buffer=new Int32Array(this.sharedBuffer)}get width(){return Atomics.load(this.buffer,0)}set width(a){Atomics.store(this.buffer,0,a)}get height(){return Atomics.load(this.buffer,1)}set height(a){Atomics.store(this.buffer,1,a)}}},{}]},{},[2]);